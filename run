#!/bin/bash

# Check if the argument is 'install'
if [ "$1" == "install" ]; then
  echo "Installing.."
  npm install
  npm run build
  if [ $? -eq 0 ]; then
    echo "Install succeeded"
    exit 0
  else
    echo "Install failed"
    exit 1
  fi
fi

if [ "$1" == "test" ]; then
  # Run the tests and generate a coverage report, capturing output
  OUTPUT=$(npx vitest run --coverage)
  VITEST_EXIT_CODE=$?

  # Check the exit code of the test command
  if [ $VITEST_EXIT_CODE -ne 0 ]; then
    echo "Tests failed"
    exit 1
  fi

  # Extract the number of tests passed and total tests
  TEST_PASSED=$(echo "$OUTPUT" | grep 'Tests' | awk '{print $2}')
  TEST_RUN=$(echo "$OUTPUT" | grep 'Tests' | awk -F'[()]' '{print $2}')

  
  # Extract line coverage percentage
  COVERAGE_PERCENT=$(echo "$OUTPUT" | grep 'All files' | awk '{print $10}')

  # Round the coverage percentage to the nearest whole number
  COVERAGE_ROUNDED=$(printf "%.0f" "$COVERAGE_PERCENT")

  # Output the results in the specified format
  echo "$TEST_PASSED/$TEST_RUN test cases passed. $COVERAGE_ROUNDED% line coverage achieved."

  exit 0
fi

# Handle other cases
node dist/index.js "$1"
